/**
 * @fileoverview Firestore Security Rules for Blak Whyte Studio Hub.
 *
 * Core Philosophy:
 * This ruleset employs a combination of public read access for general content (services, products, gallery) and strict user-ownership for private data (bookings, invoices).  Admin roles are managed via document existence in a separate collection.
 *
 * Data Structure:
 * - /services/{serviceId}: Publicly accessible service information.
 * - /users/{userId}/bookings/{bookingId}: User-specific bookings, accessible only by the owner.
 * - /users/{userId}/invoices/{invoiceId}: User-specific invoices, accessible only by the owner.
 * - /products/{productId}: Publicly accessible product information.
 * - /gallery_images/{galleryImageId}: Publicly accessible gallery images.
 * - /roles_admin/{userId}: Documents indicating admin status; existence implies admin role.
 *
 * Key Security Decisions:
 * - Public read access is granted to /services, /products, and /gallery_images to showcase content.
 * - User listing is disabled on /users to protect user privacy.
 * - Write access to user-owned data (bookings, invoices) is strictly enforced via path-based ownership.
 * - Admin roles are determined by document existence in /roles_admin, not by document content.
 *
 * Denormalization for Authorization:
 * Path-based ownership is leveraged throughout the user subcollections to simplify authorization logic and avoid expensive `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @param {string} userId The user's ID.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner (specified in the path).
     * @param {string} userId The user's ID.
     * @return {boolean} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner and the resource exists.
     *              Use this function for update and delete operations to prevent acting on non-existent documents.
     * @param {string} userId The user's ID.
     * @return {boolean} True if the request is made by the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Services collection: Public read, no writes.
     * @path /services/{serviceId}
     * @allow (get, list): Any user can read service information to display on the UI.
     * @deny (create, update, delete): No one can create, update, or delete services via client-side rules.  These operations should be handled by trusted backend environments.
     * @principle Public read access for general content.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description User Bookings: Owner can manage their own bookings.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow (create): A user can create a booking under their own user ID, provided the clientId matches their UID.
     * @allow (get, list): A user can read their own bookings.
     * @allow (update, delete): A user can update/delete their own booking if it exists.
     * @deny (create): A user cannot create a booking under another user's ID.
     * @deny (get, list, update, delete): A user cannot read, update, or delete another user's bookings.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.clientId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.clientId == resource.data.clientId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description User Invoices: Owner can manage their own invoices.
     * @path /users/{userId}/invoices/{invoiceId}
     * @allow (create): A user can create an invoice under their own user ID.
     * @allow (get, list): A user can read their own invoices.
     * @allow (update, delete): A user can update/delete their own invoice if it exists.
     * @deny (create): A user cannot create an invoice under another user's ID.
     * @deny (get, list, update, delete): A user cannot read, update, or delete another user's invoices.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/invoices/{invoiceId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Products collection: Public read, no writes.
     * @path /products/{productId}
     * @allow (get, list): Any user can read product information.
     * @deny (create, update, delete): No one can create, update, or delete products via client-side rules.
     * @principle Public read access for general content.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Gallery Images collection: Public read, no writes.
     * @path /gallery_images/{galleryImageId}
     * @allow (get, list): Any user can read gallery image information.
     * @deny (create, update, delete): No one can create, update, or delete gallery images via client-side rules.
     * @principle Public read access for general content.
     */
    match /gallery_images/{galleryImageId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Admin Roles: Only admins can create/delete admin roles.  Reads are allowed for all to determine admin status.
     * @path /roles_admin/{userId}
     * @allow (get, list): Any signed-in user can check for the existence of admin roles (e.g., to show admin UI elements).
     * @allow (create): Only admins can create admin roles.
     * @allow (delete): Only admins can delete admin roles.
     * @deny (update): No updates allowed.
     * @principle Role-based access control.
     */
    match /roles_admin/{userId} {
        allow get, list: if isSignedIn();
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
    }
  }
}