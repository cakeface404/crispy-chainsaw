/**
 * @fileoverview Firestore Security Rules for Blak Whyte Studio Hub.
 *
 * Core Philosophy:
 * This ruleset employs a combination of public read access for general content (services, products, gallery) and role-based access for sensitive data like bookings. Admins have broad read access, while users have restricted write access.
 *
 * Data Structure:
 * - /services/{serviceId}: Publicly accessible service information.
 * - /bookings/{bookingId}: Booking documents. Can be created by any user, but only read/managed by admins.
 * - /products/{productId}: Publicly accessible product information.
 * - /gallery/{galleryImageId}: Publicly accessible gallery images.
 * - /users/{userId}: User profile information. Writable by the user, readable by admins.
 * - /admins/{userId}: A collection where the document ID is a user's UID. Existence implies admin role.
 *
 * Key Security Decisions:
 * - Public read access is granted to /services, /products, and /gallery to showcase content.
 * - Any user can create a booking to allow for guest checkouts, but only admins can list/view all bookings.
 * - User data in /users is protected, only writable by the owner and readable by admins.
 * - Admin role is determined by checking for the user's UID in the /admins collection. This is a secure and efficient way to manage roles.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * @description Checks if the request is made by the owner (specified in the path).
     * @param {string} userId The user's ID.
     * @return {boolean} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Services collection: Publicly readable for all users.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow write: if false; // Should be managed by an admin interface/backend
    }

    /**
     * @description Products collection: Publicly readable for all users.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow write: if false; // Should be managed by an admin interface/backend
    }


    /**
     * @description Gallery collection: Publicly readable for all users.
     */
    match /gallery/{galleryImageId} {
      allow get, list: if true;
      allow write: if false; // Should be managed by an admin interface/backend
    }

    /**
     * @description Users collection: Users can create their own profile.
     * Only the owner can update their profile. Admins can read user profiles.
     */
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow create: if true; // Allow user creation during booking
      allow update: if isOwner(userId);
      allow delete: if isAdmin();
    }

    /**
     * @description Bookings collection: Any user can create a booking (to support guest booking).
     * Only admins can read, update, or delete bookings.
     */
    match /bookings/{bookingId} {
      allow list, get, update, delete: if isAdmin();
      allow create: if true; // Allows anyone to create a booking
    }

    /**
     * @description Admins collection: Only admins can read/write the list of admins.
     */
    match /admins/{userId} {
      allow read, write: if isAdmin();
    }
  }
}
